<?xml version="1.0"?>
<rules xmlns="http://www.xebialabs.com/xl-deploy/xl-rules">

    <rule name="startStopServer" scope="plan">
        <script-ref ref="planning/start-stop-server.py"/>
    </rule>

    <rule name="deployArtifact" scope="deployed">
        <coditions>
            <type>example.Artifact</type>
            <operation>CREATE</operation>
            <operation>MODIFY</operation>
        </coditions>

        <steps>
    		<execute-remote-os-script>
    			<description expression="true">"Deploy " + deployed.name + " on " + deployed.container.name</description>
    			<order>70</order>
    			<container expression="true">deployed.container.host</container>
    			<script-template-path>scripts/deploy-artifact</script-template-path>
    			<derived-artifact expression="true">deployed</derived-artifact>
                <vars>
                    <deployed expression="true">deployed</deployed>
                </vars>
    		</execute-remote-os-script>
    	</steps>
    </rule>

    <rule name="destroyArtifact" scope="deployed">
        <conditions>
            <type>example.Artifact</type>
            <operation>DESTROY</operation>
        </conditions>

        <steps>
            <execute-remote-os-script>
                <description expression="true">"Destroy " + deployed.name + " on " + deployed.container.name</description>
                <order>30</order>
                <container expression="true">deployed.container.host</container>
                <script-template-path>scripts/undeploy-artifact</script-template-path>
                <vars>
                    <deployed expression="true">deployed</deployed>
                </vars>
            </execute-remote-os-script>
        </steps>
    </rule>

    <rule name="deployResource" scope="deployed">
        <conditions>
            <type>example.Resource</type>
            <operation>CREATE</operation>
            <operation>MODIFY</operation>
        </conditions>

        <steps>
            <copy-artifact>
                <description>Create Resource</description>
                <order>60</order>
                <source-file expression="true">deployed.file</source-file>
                <container expression="true">deployed.container.host</container>
                <target-path expression="true">deployed.container.home + "/resources"</target-path>
                <target-file-name expression="true">deployed.file.name</target-file-name>
                <create-target-path>true</create-target-path>
            </copy-artifact>
    	</steps>
    </rule>

    <rule name="destroyResource" scope="deployed">
        <conditions>
            <type>example.Resource</type>
            <operation>DESTROY</operation>
        </conditions>

        <steps>
            <delete-artifact>
                <description>Delete Resource</description>
                <order>40</order>
                <container expression="true">deployed.container.host</container>
                <target-directory expression="true">deployed.container.home + "/resources"</target-directory>
                <target-file expression="true">deployed.file.name</target-file>
            </delete-artifact>
        </steps>
    </rule>

    <rule name="deployDatasource" scope="deployed">
        <conditions>
            <type>example.Datasource</type>
            <operation>CREATE</operation>
            <operation>MODIFY</operation>
        </conditions>

        <steps>
            <resolve-template>
    			<description expression="true">"Deploy " + deployed.name + " to " + deployed.container.name</description>
                <order>60</order>
                <container expression="true">deployed.container.host</container>
                <target-path expression="true">deployed.container.home + "/conf"</target-path>
                <target-file-name expression="true">deployed.name</target-file-name>
                <create-target-path>true</create-target-path>
                <template-path>templates/datasource.ftl</template-path>
                <vars>
                    <deployed expression="true">deployed</deployed>
                    <prop>myProp</prop>
                </vars>
            </resolve-template>
    	</steps>
    </rule>

    <rule name="emailRule" scope="post-plan">
        <script>
<![CDATA[

email = specification.deployedOrPreviousApplication.email

if(specification.operation != "NOOP" and email is not None):
	context.addStep(steps.success(description = "Sending an email to " + email + " that deployment is finished", order = 99))

]]>
        </script>
    </rule>
</rules>
